<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>🦾 تحدي العمالقة – نسخة فردية</title>
  <style>
    body {
      margin: 0;
      font-family: "Tahoma", sans-serif;
      background: linear-gradient(135deg, #6a0dad, #8b52ff);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }
    .container {
      background: #fff;
      width: 380px;
      max-width: 95vw;
      border-radius: 16px;
      padding: 20px 25px 25px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      text-align: center;
    }
    h1 {
      margin: 0 0 8px;
      color: #6a0dad;
      font-size: 26px;
    }
    .subtitle {
      margin: 0 0 18px;
      color: #777;
      font-size: 14px;
    }
    .info {
      font-size: 13px;
      color: #555;
      margin-bottom: 12px;
    }
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }
    .mode-select {
      display: flex;
      gap: 10px;
      margin: 14px 0 12px;
    }
    .mode-btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d6c5ff;
      background: #f4ecff;
      color: #5b2c83;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }
    .mode-btn.active {
      background: #6a0dad;
      color: #fff;
      border-color: #6a0dad;
    }
    .players-select {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      justify-content: center;
    }
    .players-select button {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d6c5ff;
      background: #f4ecff;
      color: #5b2c83;
      cursor: pointer;
      font-size: 13px;
    }
    .players-select button.active {
      background: #6a0dad;
      color: #fff;
      border-color: #6a0dad;
    }
    .friends-inputs {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    .friends-inputs input {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .music-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
    }
    .share-box {
      background: #f7f2ff;
      border-radius: 12px;
      padding: 10px;
      margin: 8px 0 12px;
    }
    .share-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .share-row input {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .share-row button {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      background: #6a0dad;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .share-note {
      font-size: 12px;
      color: #666;
    }
    #qrImage,
    #qrCanvas {
      width: 140px;
      height: 140px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e4d7ff;
    }
    #startBtn {
      margin-top: 6px;
      padding: 10px;
      width: 100%;
      border-radius: 10px;
      border: none;
      background: #ffaa00;
      color: #4b0082;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }
    #startBtn:hover {
      background: #ffcc33;
    }
    #categorySelect {
      margin-bottom: 15px;
    }
    select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
    }
    #questionBox {
      background: #f7f2ff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 15px;
    }
    #questionNumber {
      font-size: 13px;
      color: #888;
      margin-bottom: 4px;
    }
    #questionText {
      font-size: 17px;
      color: #333;
      margin: 0;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    .choice {
      background: #6a0dad;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 9px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }
    .choice:hover {
      background: #8b52ff;
    }
    .choice.disabled {
      opacity: 0.6;
      cursor: default;
    }
    #feedback {
      min-height: 24px;
      font-size: 14px;
      margin-top: 4px;
    }
    #scoreBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 13px;
      margin-top: 10px;
    }
    #score {
      font-weight: bold;
      color: #4b0082;
    }
    #turn {
      font-weight: bold;
      color: #6a0dad;
    }
    #timer {
      color: #b00020;
      font-weight: bold;
    }
    #nextBtn, #restartBtn, #backBtn {
      margin-top: 12px;
      padding: 9px;
      width: 100%;
      border-radius: 10px;
      border: none;
      background: #ffaa00;
      color: #4b0082;
      font-size: 15px;
      cursor: pointer;
      display: none;
      transition: 0.2s;
    }
    #nextBtn:hover, #restartBtn:hover, #backBtn:hover {
      background: #ffcc33;
    }
    #winMessage {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
      color: #4b0082;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="startScreen" class="screen active">
      <h1>🦾 تحدي العمالقة 🦾</h1>
      <p class="subtitle">نسخة فردية أو تحدي بين الأصدقاء – كل إجابة صحيحة = 5 نقاط</p>
      <div class="info">اختر نمط اللعب، عدد اللاعبين (حتى 6)، واضبط الأسماء، ثم ابدأ التحدي.</div>

      <div class="mode-select">
        <button class="mode-btn active" data-mode="solo">لعب فردي</button>
        <button class="mode-btn" data-mode="friends">تحدي الأصدقاء</button>
      </div>

      <div class="players-select" id="playersSelect">
        <button data-count="1" class="active">1 لاعب</button>
        <button data-count="2">2 لاعبين</button>
        <button data-count="3">3 لاعبين</button>
        <button data-count="4">4 لاعبين</button>
        <button data-count="5">5 لاعبين</button>
        <button data-count="6">6 لاعبين</button>
      </div>

      <div id="friendsInputs" class="friends-inputs"></div>

      <label class="music-toggle">
        <input id="musicToggle" type="checkbox" checked />
        موسيقى خلفية
      </label>

      <div class="share-box">
        <div class="share-row">
          <input id="shareLink" type="text" placeholder="رابط المشاركة" />
          <button id="copyLinkBtn">نسخ</button>
        </div>
        <div class="share-row" style="justify-content:center;">
          <canvas id="qrCanvas" aria-label="QR"></canvas>
          <img id="qrImage" alt="QR" style="display:none;" />
        </div>
        <div id="shareNote" class="share-note"></div>
      </div>

      <button id="startBtn">ابدأ التحدي</button>
    </div>

    <div id="gameScreen" class="screen">
      <h1>🦾 تحدي العمالقة 🦾</h1>
      <p class="subtitle">نسخة فردية بسيطة – أول من يصل 50 نقطة يفوز</p>

      <div class="info">
        اختر فئة الأسئلة أو "فئات متنوعة"، ثم اضغط على أي خيار للإجابة.
      </div>

      <div id="categorySelect">
        <select id="category">
          <option value="mixed">🎲 فئات متنوعة</option>
          <option value="capitals">🗺️ عواصم الدول</option>
          <option value="football">⚽ كرة القدم</option>
          <option value="tv_shows">🎬 المسلسلات</option>
          <option value="general">🧠 أسئلة عامة</option>
          <option value="science">🧪 العلوم</option>
          <option value="history">📜 التاريخ</option>
          <option value="music">🎵 الموسيقى</option>
          <option value="games">🎮 الألعاب</option>
          <option value="food">🍔 الطعام</option>
          <option value="arab">👑 ثقافة عربية</option>
          <option value="tech">💻 التقنية</option>
        </select>
      </div>

      <div id="questionBox">
        <div id="questionNumber">السؤال 1</div>
        <p id="questionText">اختر فئة، وسيتم تحميل أول سؤال...</p>
      </div>

      <div class="choices" id="choices"></div>

      <div id="feedback"></div>

      <div id="scoreBar">
        <span id="score">النقاط: 0</span>
        <span id="turn">الدور: -</span>
        <span id="timer">الوقت: -</span>
      </div>

      <button id="nextBtn">السؤال التالي</button>
      <button id="restartBtn">🔁 إعادة اللعب</button>
      <button id="backBtn">⬅ العودة للبداية</button>

      <div id="winMessage"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script>
    // قاعدة الأسئلة (نفس الفئات اللي صممناها للملتي بلاير)
    const questionBank = {
      capitals: [
        { text: "ما عاصمة اليابان؟", choices: ["أوساكا", "كيوتو", "طوكيو", "ناجويا"], correct: "طوكيو" },
        { text: "ما عاصمة إسبانيا؟", choices: ["مدريد", "برشلونة", "إشبيلية", "فالنسيا"], correct: "مدريد" },
        { text: "ما عاصمة كندا؟", choices: ["فانكوفر", "مونتريال", "تورونتو", "أوتاوا"], correct: "أوتاوا" },
        { text: "ما عاصمة مصر؟", choices: ["الإسكندرية", "الجيزة", "القاهرة", "الأقصر"], correct: "القاهرة" },
        { text: "ما عاصمة المغرب؟", choices: ["فاس", "مراكش", "الرباط", "طنجة"], correct: "الرباط" }
      ],
      football: [
        { text: "من فاز بكأس العالم 2022؟", choices: ["فرنسا", "البرازيل", "الأرجنتين", "ألمانيا"], correct: "الأرجنتين" },
        { text: "كم عدد بطولات ريال مدريد في دوري الأبطال حتى 2024؟", choices: ["11", "12", "14", "15"], correct: "15" },
        { text: "من هو اللاعب المعروف بالسلطان؟", choices: ["رونالدو", "إبراهيموفيتش", "مبابي", "صلاح"], correct: "إبراهيموفيتش" },
        { text: "من الدولة المستضيفة لكأس العالم 2010؟", choices: ["فرنسا", "جنوب إفريقيا", "البرازيل", "قطر"], correct: "جنوب إفريقيا" },
        { text: "من أكثر لاعب حصل على كرة ذهبية؟", choices: ["ميسي", "كريستيانو", "زيدان", "رونالدو البرازيلي"], correct: "ميسي" }
      ],
      tv_shows: [
        { text: "من بطل مسلسل Breaking Bad؟", choices: ["ريتشارد كرايم", "والتر وايت", "توماس شيلبي", "مايك روس"], correct: "والتر وايت" },
        { text: "مسلسل Game of Thrones من نوع:", choices: ["درامي", "كوميدي", "فانتازيا", "رياضي"], correct: "فانتازيا" },
        { text: "مسلسل 'الهيبة' من بطولة:", choices: ["قصي خولي", "تيم حسن", "باسل خياط", "عابد فهد"], correct: "تيم حسن" },
        { text: "مسلسل La Casa De Papel دولة إنتاجه:", choices: ["المكسيك", "إسبانيا", "البرتغال", "فرنسا"], correct: "إسبانيا" },
        { text: "مسلسل Suits تدور قصته حول:", choices: ["الأطباء", "الشرطة", "المحامون", "المهندسون"], correct: "المحامون" }
      ],
      general: [
        { text: "كم عدد قارات العالم؟", choices: ["5", "6", "7", "8"], correct: "7" },
        { text: "من مؤسس شركة مايكروسوفت؟", choices: ["بيل غيتس", "ستيف جوبز", "مارك زوكربيرغ", "جيف بيزوس"], correct: "بيل غيتس" },
        { text: "أكبر محيط في العالم؟", choices: ["الأطلسي", "الهادي", "الهندي", "المتجمد الشمالي"], correct: "الهادي" },
        { text: "العاصمة الاقتصادية للصين؟", choices: ["بكين", "شنغهاي", "هونغ كونغ", "تيانجين"], correct: "شنغهاي" }
      ],
      science: [
        { text: "ما الكوكب الأحمر؟", choices: ["الزهرة", "عطارد", "المريخ", "زحل"], correct: "المريخ" },
        { text: "من اخترع المصباح الكهربائي؟", choices: ["إديسون", "نيوتن", "آينشتاين", "بيل"], correct: "إديسون" },
        { text: "عدد الكواكب في المجموعة الشمسية؟", choices: ["7", "8", "9", "10"], correct: "8" },
        { text: "العنصر الكيميائي للماء هو:", choices: ["O2", "H2O", "CO2", "N2"], correct: "H2O" },
        { text: "العالم صاحب نظرية الجاذبية:", choices: ["نيوتن", "أديسون", "داروين", "آينشتاين"], correct: "نيوتن" }
      ],
      history: [
        { text: "تأسست المملكة العربية السعودية عام:", choices: ["1930", "1932", "1940", "1929"], correct: "1932" },
        { text: "من أول خليفة عباسي؟", choices: ["المنصور", "أبو العباس السفاح", "المأمون", "هارون الرشيد"], correct: "أبو العباس السفاح" },
        { text: "مكتشف أمريكا:", choices: ["ماجلان", "فاسكو دي غاما", "كولومبوس", "كابتن كوك"], correct: "كولومبوس" },
        { text: "الحرب التي بدأت عام 1939:", choices: ["العالمية الأولى", "العالمية الثانية", "الباردة", "الخليج"], correct: "العالمية الثانية" }
      ],
      music: [
        { text: "من مغني أغنية Thriller؟", choices: ["إلفيس بريسلي", "مايكل جاكسون", "برونو مارس", "دريك"], correct: "مايكل جاكسون" },
        { text: "الفنان المصري المعروف بلقب العندليب؟", choices: ["عبد الحليم حافظ", "عمرو دياب", "محمد فوزي", "محمد رشدي"], correct: "عبد الحليم حافظ" },
        { text: "آلة ذات أوتار تُستخدم في الموسيقى الشرقية:", choices: ["الغيتار", "الناي", "العود", "البيانو"], correct: "العود" },
        { text: "ما اسم الجائزة الموسيقية العالمية الشهيرة؟", choices: ["الأوسكار", "الجرامي", "الإيمي", "الفيفا"], correct: "الجرامي" }
      ],
      games: [
        { text: "من الشخصية الرئيسية في لعبة Super Mario؟", choices: ["لويد", "ماريو", "ليو", "سونك"], correct: "ماريو" },
        { text: "شركة تطوير لعبة Fortnite؟", choices: ["EA", "Epic Games", "Valve", "Ubisoft"], correct: "Epic Games" },
        { text: "في أي عام صدرت لعبة Minecraft؟", choices: ["2007", "2009", "2011", "2013"], correct: "2011" },
        { text: "ما وحدة العملة داخل FIFA Ultimate Team؟", choices: ["Gems", "Points", "Coins", "Gold"], correct: "Coins" }
      ],
      food: [
        { text: "منشأ طبق السوشي؟", choices: ["الصين", "كوريا", "اليابان", "تايلاند"], correct: "اليابان" },
        { text: "أشهر أكلة إيطالية؟", choices: ["البيتزا", "السوشي", "الكاري", "التاكو"], correct: "البيتزا" },
        { text: "المقلوبة أكلة تقليدية في:", choices: ["فلسطين", "سوريا", "العراق", "مصر"], correct: "فلسطين" },
        { text: "طبق الكبسة مشهور في:", choices: ["مصر", "السعودية", "المغرب", "لبنان"], correct: "السعودية" }
      ],
      arab: [
        { text: "ما الدولة التي يُقام فيها مهرجان الجنادرية؟", choices: ["السعودية", "الإمارات", "الكويت", "مصر"], correct: "السعودية" },
        { text: "من القائل: إذا الشعب يوماً أراد الحياة؟", choices: ["المتنبي", "أبو القاسم الشابي", "نزار قباني", "إيليا أبو ماضي"], correct: "أبو القاسم الشابي" },
        { text: "ما أشهر طبق تونسي تقليدي؟", choices: ["الكسكسي", "الكبسة", "الفتوش", "المنسف"], correct: "الكسكسي" },
        { text: "العملة الرسمية في الأردن:", choices: ["الدينار", "الدرهم", "الريال", "الجنيه"], correct: "الدينار" }
      ],
      tech: [
        { text: "ما نظام التشغيل الخاص بشركة آبل؟", choices: ["Windows", "Android", "iOS", "Linux"], correct: "iOS" },
        { text: "من أسس شركة تسلا؟", choices: ["بيل غيتس", "إيلون ماسك", "ستيف جوبز", "جيف بيزوس"], correct: "إيلون ماسك" },
        { text: "الذكاء الاصطناعي يُختصر عادةً بـ:", choices: ["AI", "ML", "VR", "AR"], correct: "AI" },
        { text: "شركة تطوير لغة البرمجة Python؟", choices: ["مايكروسوفت", "جوجل", "OpenAI", "لا أحد - مفتوحة المصدر"], correct: "لا أحد - مفتوحة المصدر" }
      ]
    };

    // دوال مساعدة
    function shuffle(arr) {
      return [...arr].sort(() => Math.random() - 0.5);
    }

    const startScreen = document.getElementById("startScreen");
    const gameScreen = document.getElementById("gameScreen");
    const modeButtons = document.querySelectorAll(".mode-btn");
    const playersSelect = document.getElementById("playersSelect");
    const friendsInputs = document.getElementById("friendsInputs");
    const musicToggle = document.getElementById("musicToggle");
    const startBtn = document.getElementById("startBtn");

    const shareLinkInput = document.getElementById("shareLink");
    const qrImage = document.getElementById("qrImage");
    const qrCanvas = document.getElementById("qrCanvas");
    const shareNote = document.getElementById("shareNote");
    const copyLinkBtn = document.getElementById("copyLinkBtn");

    const categorySelect = document.getElementById("category");
    const questionNumberDiv = document.getElementById("questionNumber");
    const questionTextP = document.getElementById("questionText");
    const choicesDiv = document.getElementById("choices");
    const feedbackDiv = document.getElementById("feedback");
    const scoreSpan = document.getElementById("score");
    const turnSpan = document.getElementById("turn");
    const timerSpan = document.getElementById("timer");
    const nextBtn = document.getElementById("nextBtn");
    const restartBtn = document.getElementById("restartBtn");
    const backBtn = document.getElementById("backBtn");
    const winMessageDiv = document.getElementById("winMessage");

    let questions = [];
    let currentIndex = 0;
    let timerInterval;
    let timeLeft = 15;
    const WIN_SCORE = 50;
    const POINTS = 5;

    let gameMode = "solo";
    let playerCount = 1;
    let players = [];
    let currentPlayerIndex = 0;

    let audioCtx = null;
    let musicInterval = null;

    function setMode(mode) {
      gameMode = mode;
      modeButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
      });
      if (mode === "solo") {
        setPlayerCount(1);
      }
    }

    function setPlayerCount(count) {
      playerCount = count;
      playersSelect.querySelectorAll("button").forEach(btn => {
        btn.classList.toggle("active", Number(btn.dataset.count) === count);
      });
      buildPlayerInputs();
    }

    function buildPlayerInputs() {
      friendsInputs.innerHTML = "";
      for (let i = 0; i < playerCount; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "اسم اللاعب " + (i + 1);
        input.value = "لاعب " + (i + 1);
        input.dataset.index = i;
        friendsInputs.appendChild(input);
      }
    }

    function playNote(freq, duration) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "triangle";
      osc.frequency.value = freq;
      gain.gain.value = 0.0001;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      gain.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      osc.start(now);
      osc.stop(now + duration);
    }

    function startMusic() {
      if (!musicToggle.checked) return;
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === "suspended") audioCtx.resume();
      if (musicInterval) return;

      const notes = [261.63, 329.63, 392.0, 523.25, 392.0, 329.63];
      let idx = 0;
      musicInterval = setInterval(() => {
        playNote(notes[idx % notes.length], 0.25);
        idx++;
      }, 350);
    }

    function stopMusic() {
      if (musicInterval) clearInterval(musicInterval);
      musicInterval = null;
      if (audioCtx && audioCtx.state !== "suspended") audioCtx.suspend();
    }

    musicToggle.addEventListener("change", () => {
      if (musicToggle.checked) {
        startMusic();
      } else {
        stopMusic();
      }
    });

    function updateShareUI() {
      if (!shareLinkInput.value) {
        shareLinkInput.value = window.location.href;
      }
      const link = shareLinkInput.value.trim();
      const isFile = link.startsWith("file:");
      if (isFile) {
        shareNote.textContent = "هذا رابط محلي لا يمكن للأصدقاء فتحه. ارفع الصفحة على استضافة ثم ضع الرابط هنا.";
      } else {
        shareNote.textContent = "ارسل الرابط أو امسح الباركود للمشاركة.";
      }
      if (window.QRious && qrCanvas) {
        qrImage.style.display = "none";
        qrCanvas.style.display = "block";
        new QRious({
          element: qrCanvas,
          value: link || " ",
          size: 140,
          level: "M"
        });
      } else {
        qrCanvas.style.display = "none";
        qrImage.style.display = "block";
        const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=" + encodeURIComponent(link || " ");
        qrImage.src = qrUrl;
      }
    }

    copyLinkBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(shareLinkInput.value.trim());
        copyLinkBtn.textContent = "تم النسخ";
        setTimeout(() => (copyLinkBtn.textContent = "نسخ"), 1200);
      } catch {
        copyLinkBtn.textContent = "انسخه يدويا";
        setTimeout(() => (copyLinkBtn.textContent = "نسخ"), 1200);
      }
    });

    shareLinkInput.addEventListener("input", updateShareUI);

    function updateScoreBar() {
      if (playerCount > 1) {
        const text = players.map(p => p.name + ": " + p.score).join(" | ");
        scoreSpan.textContent = text;
        turnSpan.textContent = "الدور: " + players[currentPlayerIndex].name;
      } else {
        scoreSpan.textContent = "النقاط: " + players[0].score;
        turnSpan.textContent = "الدور: -";
      }
    }

    function loadCategory() {
      const cat = categorySelect.value;
      if (cat === "mixed") {
        let merged = [];
        for (const key in questionBank) {
          merged = merged.concat(questionBank[key]);
        }
        questions = shuffle(merged);
      } else {
        questions = shuffle(questionBank[cat] || questionBank.general);
      }
      currentIndex = 0;
      currentPlayerIndex = 0;
      players.forEach(p => (p.score = 0));
      winMessageDiv.textContent = "";
      restartBtn.style.display = "none";
      nextBtn.style.display = "none";
      backBtn.style.display = "block";
      updateScoreBar();
      showQuestion();
    }

    function showQuestion() {
      clearInterval(timerInterval);
      timeLeft = 15;
      timerSpan.textContent = "الوقت: " + timeLeft + " ثانية";
      feedbackDiv.textContent = "";
      nextBtn.style.display = "none";
      updateScoreBar();

      if (currentIndex >= questions.length) {
        questionNumberDiv.textContent = "انتهت الأسئلة";
        questionTextP.textContent = "انتهت الأسئلة";
        choicesDiv.innerHTML = "";
        restartBtn.style.display = "block";
        return;
      }

      const q = questions[currentIndex];
      questionNumberDiv.textContent = "السؤال " + (currentIndex + 1) + " من " + questions.length;
      questionTextP.textContent = q.text;

      choicesDiv.innerHTML = "";
      q.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = choice;
        btn.onclick = () => answerQuestion(choice);
        choicesDiv.appendChild(btn);
      });

      timerInterval = setInterval(() => {
        timeLeft--;
        timerSpan.textContent = "الوقت: " + timeLeft + " ثانية";
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          lockChoices();
          feedbackDiv.textContent = "⏰ انتهى الوقت! الإجابة الصحيحة: " + q.correct;
          if (currentIndex < questions.length - 1) {
            nextBtn.style.display = "block";
          } else {
            endGame();
          }
        }
      }, 1000);
    }

    function lockChoices() {
      document.querySelectorAll(".choice").forEach(btn => {
        btn.classList.add("disabled");
        btn.disabled = true;
      });
    }

    function answerQuestion(selected) {
      clearInterval(timerInterval);
      const q = questions[currentIndex];
      lockChoices();

      if (selected === q.correct) {
        players[currentPlayerIndex].score += POINTS;
        feedbackDiv.textContent = "✅ إجابة صحيحة! +" + POINTS + " نقاط";
        updateScoreBar();

        if (players[currentPlayerIndex].score >= WIN_SCORE) {
          endGame(true, players[currentPlayerIndex].name);
          return;
        }
      } else {
        feedbackDiv.textContent = "❌ إجابة خاطئة! الصحيح هو: " + q.correct;
      }

      if (currentIndex < questions.length - 1) {
        nextBtn.style.display = "block";
      } else {
        endGame();
      }
    }

    function endGame(won = false, winnerName = "") {
      nextBtn.style.display = "none";
      restartBtn.style.display = "block";
      if (won) {
        winMessageDiv.textContent = "🏆 مبروك! " + winnerName + " وصل إلى " + WIN_SCORE + " نقطة وربح التحدي!";
      } else if (playerCount > 1) {
        const maxScore = Math.max(...players.map(p => p.score));
        const winners = players.filter(p => p.score === maxScore).map(p => p.name);
        if (winners.length > 1) {
          winMessageDiv.textContent = "انتهت الأسئلة! تعادل بين: " + winners.join(" و ");
        } else {
          winMessageDiv.textContent = "انتهت الأسئلة! الفائز: " + winners[0];
        }
      } else {
        winMessageDiv.textContent = "انتهت الأسئلة! مجموع نقاطك: " + players[0].score;
      }
    }

    function nextTurn() {
      currentIndex++;
      if (playerCount > 1) {
        currentPlayerIndex = (currentPlayerIndex + 1) % playerCount;
      }
      showQuestion();
    }

    nextBtn.onclick = () => {
      nextTurn();
    };

    restartBtn.onclick = () => {
      loadCategory();
    };

    backBtn.onclick = () => {
      clearInterval(timerInterval);
      startScreen.classList.add("active");
      gameScreen.classList.remove("active");
      winMessageDiv.textContent = "";
    };

    categorySelect.onchange = () => {
      loadCategory();
    };

    playersSelect.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const count = Number(btn.dataset.count);
        setMode(count === 1 ? "solo" : "friends");
        setPlayerCount(count);
      });
    });

    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const isSolo = btn.dataset.mode === "solo";
        setMode(btn.dataset.mode);
        if (isSolo) setPlayerCount(1);
      });
    });

    startBtn.addEventListener("click", () => {
      const inputs = Array.from(friendsInputs.querySelectorAll("input"));
      players = inputs.map((input, idx) => ({
        name: (input.value || "لاعب " + (idx + 1)).trim(),
        score: 0
      }));
      if (players.length === 0) {
        players = [{ name: "لاعب 1", score: 0 }];
      }

      startScreen.classList.remove("active");
      gameScreen.classList.add("active");

      startMusic();
      loadCategory();
    });

    // شاشة البداية افتراضيا
    setMode("solo");
    setPlayerCount(1);
    updateShareUI();
  </script>
</body>
</html>
